Лабораторная работа 7 — Архитектура, слои и DDD-lite

Учебный проект демонстрирует слоистую архитектуру (Domain / Application / Infrastructure) с применением Dependency Inversion Principle (DIP) и упрощённого подхода DDD-lite. Реализован сценарий оплаты заказа через use-case с доменной моделью и инфраструктурными адаптерами без реальной БД.

Архитектура (Слои)

Domain

Доменный слой содержит бизнес-модель и правила:

· Order — сущность (агрегат заказа)
· OrderLine — строка заказа (часть агрегата)
· Money — value object для работы с денежными суммами и валютой
· OrderStatus — статус заказа (PENDING, PAID, CANCELLED)

Инварианты домена:

· Нельзя оплатить пустой заказ
· Нельзя оплатить заказ повторно
· После оплаты нельзя изменять строки заказа
· Итоговая сумма равна сумме строк заказа

Доменный слой полностью независим от внешних систем и инфраструктуры.

Application

Слой приложений содержит use-case PayOrderUseCase, который:

1. Загружает заказ через OrderRepository.get_by_id(order_id)
2. Выполняет доменную операцию оплаты (изменяет состояние заказа согласно бизнес-правилам)
3. Вызывает платеж через PaymentGateway.charge(order_id, money)
4. Сохраняет обновленный заказ через OrderRepository.save(order)
5. Возвращает структурированный результат оплаты PaymentResult

Application слой зависит только от абстракций (интерфейсов), а не от конкретных реализаций.

Infrastructure

Инфраструктурный слой содержит реализации интерфейсов:

· InMemoryOrderRepository — репозиторий, хранящий заказы в памяти (для тестов и демонстрации)
· FakePaymentGateway — тестовый платежный шлюз, имитирующий процесс оплаты без реальных списаний

Infrastructure подключается "снаружи" и не влияет на доменную логику.

Интерфейсы

OrderRepository:
get_by_id(order_id)
save(order)

PaymentGateway:
charge(order_id, money)

Тесты:

Тесты проверяют use-case и доменные правила без использования реальной базы данных:

·  Успешная оплата корректного заказа
·  Ошибка при попытке оплаты пустого заказа
·  Ошибка при повторной оплате уже оплаченного заказа
·  Невозможность изменения заказа после оплаты
·  Корректный расчёт итоговой суммы заказа

Проверка работоспособности:
Для проверки работы лабораторной используется запуск unit-тестов:

python -m pytest -q
